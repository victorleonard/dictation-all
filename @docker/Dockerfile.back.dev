# Dockerfile pour le backend Symfony (Mode Développement)
FROM php:8.2-fpm-alpine

# Installer les dépendances système nécessaires
RUN apk add --no-cache \
    git \
    unzip \
    mysql-client \
    mariadb-dev \
    icu-dev \
    libzip-dev \
    oniguruma-dev \
    bash \
    && docker-php-ext-install \
    pdo \
    pdo_mysql \
    intl \
    zip \
    opcache

# Installer Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Configuration PHP pour le développement
RUN echo "memory_limit=512M" >> /usr/local/etc/php/conf.d/docker-php-memlimit.ini && \
    echo "upload_max_filesize=20M" >> /usr/local/etc/php/conf.d/docker-php-uploads.ini && \
    echo "post_max_size=20M" >> /usr/local/etc/php/conf.d/docker-php-uploads.ini

# Configuration OPcache pour le développement (validation des timestamps activée)
RUN echo "opcache.enable=1" >> /usr/local/etc/php/conf.d/opcache.ini && \
    echo "opcache.memory_consumption=256" >> /usr/local/etc/php/conf.d/opcache.ini && \
    echo "opcache.validate_timestamps=1" >> /usr/local/etc/php/conf.d/opcache.ini && \
    echo "opcache.revalidate_freq=0" >> /usr/local/etc/php/conf.d/opcache.ini

# Créer un utilisateur non-root pour la sécurité
RUN addgroup -g 1000 appuser && \
    adduser -u 1000 -G appuser -s /bin/sh -D appuser

# Définir le répertoire de travail
WORKDIR /app

# Passer à l'utilisateur non-root
USER appuser

# Exposer le port 9000 (port par défaut de PHP-FPM)
EXPOSE 9000

# Commande par défaut
CMD ["php-fpm"]
